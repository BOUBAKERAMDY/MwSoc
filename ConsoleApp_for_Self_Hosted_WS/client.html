<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Let's Go Biking! - REST Client</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background: #f7f9fc;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #0078d7;
            text-align: center;
        }

        .main-layout {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 25px;
            flex-wrap: wrap;
            max-width: 1200px;
            margin: 0 auto;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
            flex: 1;
            min-width: 400px;
            max-width: 550px;
        }

        #map-container {
            flex: 1;
            min-width: 400px;
            max-width: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            background: #0078d7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            margin-top: 15px;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: #005fa3;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .card {
            background: #f0f4fa;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .suggestions {
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-top: 2px;
            position: absolute;
            z-index: 1000;
            width: calc(100% - 22px);
            max-height: 200px;
            overflow-y: auto;
        }

        .suggestions div {
            padding: 6px;
            cursor: pointer;
        }

        .suggestions div:hover {
            background: #0078d7;
            color: white;
        }

        #map {
            height: 400px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        h3 {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>ðŸš² Let's Go Biking â€“ REST Client</h1>

    <div class="main-layout">
        <div class="container">
            <label>Origin:</label>
            <input id="origin"
                   placeholder="Example: Place Massena, Nice"
                   oninput="showSuggestions(this, 'originList')"
                   autocomplete="off" />
            <div id="originList" class="suggestions"></div>

            <label>Destination:</label>
            <input id="destination"
                   placeholder="Example: Gare Thiers, Nice"
                   oninput="showSuggestions(this, 'destList')"
                   autocomplete="off" />
            <div id="destList" class="suggestions"></div>

            <button onclick="getItinerary()">Search Itinerary</button>

            <div id="info" class="grid" style="display: none">
                <div class="card">
                    <h3>Total Time</h3>
                    <p id="time"></p>
                </div>
                <div class="card">
                    <h3>Total Distance</h3>
                    <p id="distance"></p>
                </div>
                <div class="card">
                    <h3>Walk â†’ Station</h3>
                    <p id="walkTo"></p>
                </div>
                <div class="card">
                    <h3>Biking Segment</h3>
                    <p id="bike"></p>
                </div>
                <div class="card">
                    <h3>Walk â†’ Destination</h3>
                    <p id="walkEnd"></p>
                </div>
                <div class="card">
                    <h3>Stations</h3>
                    <p id="stations"></p>
                </div>
            </div>
        </div>

        <div id="map-container">
            <h3>Itinerary Map</h3>
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initializig map
        const map = L.map("map").setView([43.7, 7.26], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);
        let routeLayer = null;

        // Suggestions
        let suppressSuggestions = false;
        let lastSelectedValue = "";
        let suggestionTimeout;

        const NICE_LAT = 43.7;
        const NICE_LON = 7.26;

        function showSuggestions(input, listId) {
            if (suppressSuggestions) return;
            clearTimeout(suggestionTimeout);
            suggestionTimeout = setTimeout(() => loadSuggestions(input, listId), 300);
        }

        async function loadSuggestions(input, listId) {
            const list = document.getElementById(listId);
            const query = input.value.trim();
            if (query === lastSelectedValue) {
                list.innerHTML = "";
                return;
            }

            list.innerHTML = "";
            if (query.length < 3) return;

            const viewbox = "7.15,43.75,7.35,43.65";
            const urlNice = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&countrycodes=fr&limit=10&viewbox=${viewbox}&bounded=1`;
            const urlFrance = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query + ", France")}&format=json&addressdetails=1&countrycodes=fr&limit=10`;

            try {
                const [resNice, resFrance] = await Promise.all([fetch(urlNice), fetch(urlFrance)]);
                const [dataNice, dataFrance] = await Promise.all([resNice.json(), resFrance.json()]);

                const combined = [...dataNice, ...dataFrance].filter(
                    (v, i, a) => a.findIndex((t) => t.display_name === v.display_name) === i
                );

                // sort by distance to Nice
                combined.forEach((p) => {
                    const dLat = parseFloat(p.lat) - NICE_LAT;
                    const dLon = parseFloat(p.lon) - NICE_LON;
                    p._distance = Math.sqrt(dLat * dLat + dLon * dLon);
                });
                combined.sort((a, b) => a._distance - b._distance);

                combined.slice(0, 10).forEach((place) => {
                    const div = document.createElement("div");
                    const distKm = Math.round(place._distance * 111 * 10) / 10;
                    div.innerHTML = `<strong>${highlightMatch(place.display_name, query)}</strong><br><small style="color:#666">~${distKm} km from Nice</small>`;
                    div.onclick = () => {
                        suppressSuggestions = true;
                        input.value = place.display_name;
                        input.dataset.lat = place.lat;
                        input.dataset.lon = place.lon;
                        lastSelectedValue = place.display_name;
                        list.innerHTML = "";
                        input.blur();
                        setTimeout(() => (suppressSuggestions = false), 500);
                    };
                    list.appendChild(div);
                });
            } catch (err) {
                console.error("Error loading suggestions:", err);
            }
        }

        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query})`, "ig");
            return text.replace(regex, "<mark style='background: #ffeaa7;'>$1</mark>");
        }

        document.addEventListener("click", (e) => {
            document.querySelectorAll(".suggestions").forEach((list) => {
                if (!list.contains(e.target)) list.innerHTML = "";
            });
        });

        // Itinerary handler
        async function getItinerary() {
            const origin = document.getElementById("origin").value.trim();
            const destination = document.getElementById("destination").value.trim();
            const oLat = document.getElementById("origin").dataset.lat;
            const oLon = document.getElementById("origin").dataset.lon;
            const dLat = document.getElementById("destination").dataset.lat;
            const dLon = document.getElementById("destination").dataset.lon;

            if (!origin || !destination) {
                alert("Please enter both fields.");
                return;
            }

            // Choose endpoint depending on available coordinates
            let url;
            if (oLat && oLon && dLat && dLon) {
                // Call new endpoint with coordinates
                url = `http://localhost:8090/MyService/ItineraryByCoords?originLat=${oLat}&originLon=${oLon}&destLat=${dLat}&destLon=${dLon}`;
            } else {
                // Fallback to text-based endpoint
                url = `http://localhost:8090/MyService/Itinerary?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`;
            }

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(res.status + " " + res.statusText);
                const data = await res.json();

                updateCards(data);

                if (oLat && oLon && dLat && dLon) {
                    showMap(oLat, oLon, dLat, dLon, data.StartStation, data.EndStation);
                } else {
                    geocodeAndShowMap(origin, destination, data.StartStation, data.EndStation);
                }
            } catch (err) {
                console.error("Error fetching itinerary:", err);
                alert("Failed to get itinerary. Check server connection.");
            }
        }

        function updateCards(d) {
            const info = document.getElementById("info");
            info.style.display = "grid";

            document.getElementById("time").textContent = formatTime(d.TotalSeconds);
            document.getElementById("distance").textContent = (d.TotalKm || 0).toFixed(3) + " km";
            document.getElementById("walkTo").textContent = `${d.WalkToStartMeters || 0} m â€¢ ${formatTime(d.WalkToStartSeconds)}`;
            document.getElementById("bike").textContent = `${d.BikeMeters || 0} m â€¢ ${formatTime(d.BikeSeconds)}`;
            document.getElementById("walkEnd").textContent = `${d.WalkToEndMeters || 0} m â€¢ ${formatTime(d.WalkToEndSeconds)}`;
            document.getElementById("stations").textContent = `${d.StartStation || "â€”"} â†’ ${d.EndStation || "â€”"}`;
        }

        function formatTime(sec) {
            if (!sec || sec <= 0) return "0 m â€¢ 0 s";
            const min = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${min} min ${s} s`;
        }

        async function showMap(oLat, oLon, dLat, dLon, startStationName, endStationName) {
            if (routeLayer) map.removeLayer(routeLayer);

            const knownStations = {
                "Jean MÃ©decin": [43.703293, 7.266289],
                "Gambetta": [43.704515, 7.251711],
                "Massena": [43.69773, 7.27102],
                "Thiers": [43.705446, 7.266531],
                "Nice Ville": [43.7049, 7.2618],
            };

            const geo = async (q) => {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q + ", Nice, France")}&format=json&limit=1`;
                try {
                    const r = await fetch(url);
                    const j = await r.json();
                    if (j.length > 0) return [parseFloat(j[0].lat), parseFloat(j[0].lon)];
                } catch {
                    return null;
                }
                return null;
            };

            const start = [parseFloat(oLat), parseFloat(oLon)];
            const end = [parseFloat(dLat), parseFloat(dLon)];
            const s = knownStations[startStationName] || (startStationName ? await geo(startStationName) : null);
            const e = knownStations[endStationName] || (endStationName ? await geo(endStationName) : null);

            const markers = [];
            const lines = [];

            markers.push(L.marker(start).bindPopup("Origin"));
            markers.push(L.marker(end).bindPopup("Destination"));

            if (s && e) {
                lines.push(L.polyline([start, s], { color: "gray", weight: 3, dashArray: "4,6" }));
                lines.push(L.polyline([s, e], { color: "blue", weight: 5 }));
                lines.push(L.polyline([e, end], { color: "gray", weight: 3, dashArray: "4,6" }));

                markers.push(
                    L.marker(s).bindPopup(`ðŸš´ Start Station: ${startStationName}`),
                    L.marker(e).bindPopup(`ðŸš´ End Station: ${endStationName}`)
                );
            } else {
                lines.push(L.polyline([start, end], { color: "blue", weight: 4 }));
            }

            routeLayer = L.layerGroup([...markers, ...lines]).addTo(map);
            const allPoints = [start, end, s, e].filter(Boolean);
            if (allPoints.length > 0)
                map.fitBounds(allPoints, { padding: [50, 50] });
        }

        async function geocodeAndShowMap(origin, destination, s1, s2) {
            const geo = async (q) => {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1`;
                const r = await fetch(url);
                const j = await r.json();
                if (j.length > 0) return [parseFloat(j[0].lat), parseFloat(j[0].lon)];
                return null;
            };

            const o = await geo(origin);
            const d = await geo(destination);
            if (o && d) showMap(o[0], o[1], d[0], d[1], s1, s2);
        }
    </script>
</body>
</html>